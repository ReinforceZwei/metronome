<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metronome</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
</head>
<body>
    <div>
        <form method="post" enctype="multipart/form-data" id="upload">
            <input type="file" name="music_file">
            <input type="submit">
        </form>
    </div>
    
    <div>
        <audio id="musicControl" controls></audio>
    </div>
    <div>
        <input id="bpm" placeholder="bpm" value="120">
        <button id="start">Start</button>
        <button id="stop">Stop</button>
    </div>
    <div>
        <input id="newbpm" placeholder="New BPM">
        <input id="firstBeatOffset" placeholder="Beat Offset">
    </div>
<script>

const beatSound = new Audio('wooden_fish.mp3')
let music = $('#musicControl')[0]

let audioContext = new AudioContext();
let volumeGain = audioContext.createGain()
volumeGain.gain.value = 0.5;
volumeGain.connect(audioContext.destination)
let noteLength = 0.05;
function scheduleNote( beatNumber, time ) {
    // if ( (noteResolution==1) && (beatNumber%2))
    //     return; // we're not playing non-8th 16th notes
    // if ( (noteResolution==2) && (beatNumber%4))
    //     return; // we're not playing non-quarter 8th notes

    // create an oscillator
    var osc = audioContext.createOscillator();
    osc.connect( volumeGain );
    if (beatNumber % 16 === 0)    // beat 0 == high pitch
        osc.frequency.value = 880.0;
    else if (beatNumber % 4 === 0 )    // quarter notes = medium pitch
        osc.frequency.value = 440.0;
    else                        // other 16th notes = low pitch
        osc.frequency.value = 220.0;

    osc.start( time );
    osc.stop( time + noteLength );
}

let beatCounter = undefined;

let musicControl = $('#musicControl');
musicControl.on('ended', () => {
    clearInterval(beatCounter)
})
musicControl.on('seeking', () => {
    if (beatCounter) clearInterval(beatCounter)
})
musicControl.on('playing', () => {
    $('#start').click()
})
musicControl.on('pause', () => {
    if (beatCounter) clearInterval(beatCounter)
})

$('#upload input[type=file]').on('change', () => {
    music.src = URL.createObjectURL(document.querySelector('#upload input[type=file]').files[0])
    console.log("???")
})

$('#start').on('click', () => {
    //music.src = URL.createObjectURL(document.querySelector('#upload input[type=file]').files[0])
    let bpm = Number($('#bpm').val())
    let firstBeatOffset = Number($('#firstBeatOffset').val())
    
    let newbpm = $('#newbpm').val()
    let playbackRate = 1;
    if (newbpm) {
        let percentDiff = (bpm - newbpm) / bpm
        playbackRate = 1 - percentDiff
        bpm = newbpm;
        firstBeatOffset = firstBeatOffset * (1 + percentDiff)
    }
    
    let interval = 60 / bpm * 1000;
    setTimeout(() => {
        scheduleNote(0, audioContext.currentTime)
        beatCounter = setInterval(() => {
            scheduleNote(0, audioContext.currentTime)
        }, interval);
    }, firstBeatOffset * 1000)
    music.playbackRate = playbackRate;
    music.play()
})

document.getElementById('stop').addEventListener('click', () => {
    if (beatCounter) {
        clearInterval(beatCounter);
    }
    music.pause()
    music.currentTime = 0;
})

document.getElementById('upload').addEventListener('submit', (e) => {
    e.preventDefault();
    fetch('upload', {
        body: new FormData(document.getElementById('upload')),
        method: 'post'
    })
    .then(res => res.json())
    .then(json => {
        console.log(json)
        document.getElementById('bpm').value = json.bpm
        document.getElementById('firstBeatOffset').value = json.offset
        music.src = URL.createObjectURL(document.querySelector('#upload input[type=file]').files[0])
    })
    .catch(err => {
        console.error(err)
        alert(err)
    })
})

</script>
    </body>
</html>

